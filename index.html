<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeFi Pool Health Analyzer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            padding: 30px;
            backdrop-filter: blur(10px);
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .header h1 {
            font-size: 3em;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.2em;
            color: #666;
        }
        
        /* Features Section */
        .features-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
        }
        
        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .feature-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .feature-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        .feature-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .feature-card h4 {
            margin-bottom: 8px;
            color: #333;
        }
        
        .feature-card p {
            color: #666;
            font-size: 0.9em;
        }
        
        /* Watchlist Section */
        .watchlist-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .watchlist-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: white;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .watchlist-item strong {
            color: #333;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .control-group label {
            font-weight: 600;
            color: #333;
            font-size: 0.9em;
        }
        
        select, input, button {
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            min-width: 120px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .pool-list {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .pool-item {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }
        
        .pool-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .pool-item.selected {
            border-left-color: #764ba2;
            background: linear-gradient(45deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
        }
        
        .pool-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .pool-name-section {
            display: flex;
            align-items: center;
            flex: 1;
        }
        
        .pool-name {
            font-weight: 700;
            font-size: 1.1em;
            color: #333;
        }
        
        .platform-info {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 10px;
        }
        
        .platform-logo {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        
        .platform-name {
            font-weight: 600;
            font-size: 0.8em;
            color: #666;
            text-transform: uppercase;
        }
        
        .pool-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .watchlist-star {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            padding: 4px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        
        .watchlist-star:hover {
            background: #f0f0f0;
            transform: scale(1.1);
        }
        
        .watchlist-star.active {
            color: #f39c12;
        }
        
        .health-score {
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.9em;
        }
        
        .health-excellent { background: #d4edda; color: #155724; }
        .health-good { background: #d1ecf1; color: #0c5460; }
        .health-fair { background: #fff3cd; color: #856404; }
        .health-poor { background: #f8d7da; color: #721c24; }
        .health-critical { background: #f5c6cb; color: #721c24; }
        
        .pool-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            font-size: 0.9em;
            color: #666;
        }
        
        .pool-stat {
            display: flex;
            justify-content: space-between;
        }
        
        .pool-stat strong {
            color: #333;
        }
        
        .pool-enhanced-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .pool-enhanced-metric {
            text-align: center;
        }
        
        .pool-enhanced-metric-label {
            font-size: 0.7em;
            color: #888;
            margin-bottom: 2px;
        }
        
        .pool-enhanced-metric-value {
            font-size: 0.8em;
            font-weight: 600;
            color: #333;
        }
        
        .volume-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .volume-badge {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .volume-high { background: #27ae60; }
        .volume-medium { background: #f39c12; }
        .volume-low { background: #e74c3c; }
        
        .survivability-badge {
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7em;
            font-weight: 600;
            margin-left: 5px;
        }
        
        /* Fixed survivability colors - different colors for each level */
        .survivability-veteran { background: #27ae60; color: white; }  /* Green - 2+ years */
        .survivability-mature { background: #f39c12; color: white; }   /* Orange - 1+ year */
        .survivability-stable { background: #3498db; color: white; }   /* Blue - 6+ months */
        .survivability-new { background: #e74c3c; color: white; }      /* Red - <6 months */
        
        /* ADDED: New visual indicators with tooltips */
        .whale-warning-badge {
            background: #e74c3c;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7em;
            font-weight: 600;
            margin-left: 5px;
            cursor: help;
            position: relative;
        }
        
        .bonus-badge {
            background: #f39c12;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7em;
            font-weight: 600;
            margin-left: 5px;
            cursor: help;
            position: relative;
        }
        
        /* Tooltips for badges */
        .survivability-badge, .whale-warning-badge, .bonus-badge {
            position: relative;
        }
        
        .survivability-badge::after,
        .whale-warning-badge::after,
        .bonus-badge::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 120%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: normal;
            white-space: nowrap;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            pointer-events: none;
        }
        
        .survivability-badge::before,
        .whale-warning-badge::before,
        .bonus-badge::before {
            content: '';
            position: absolute;
            bottom: 112%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: #333;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .survivability-badge:hover::after,
        .survivability-badge:hover::before,
        .whale-warning-badge:hover::after,
        .whale-warning-badge:hover::before,
        .bonus-badge:hover::after,
        .bonus-badge:hover::before {
            opacity: 1;
            visibility: visible;
        }
        
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            height: 450px;
            display: flex;
            flex-direction: column;
        }
        
        .chart-wrapper {
            flex: 1;
            position: relative;
            height: 350px;
            min-height: 350px;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .chart-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
        }
        
        .chart-controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .chart-controls button {
            padding: 6px 12px;
            font-size: 0.8em;
            min-width: auto;
            text-transform: none;
            letter-spacing: normal;
        }
        
        /* Risk Analysis Section */
        .risk-analysis-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .risk-analysis-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .risk-analysis-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
        }
        
        .risk-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .risk-metric {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            position: relative;
        }
        
        .risk-metric-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 5px;
        }
        
        .risk-metric-label {
            font-size: 0.9em;
            color: #666;
        }
        
        .info-icon {
            width: 16px;
            height: 16px;
            background: #667eea;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            cursor: help;
            position: relative;
        }
        
        .tooltip {
            position: absolute;
            bottom: 120%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 13px;
            line-height: 1.4;
            width: 280px;
            text-align: left;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: #333;
        }
        
        .info-icon:hover .tooltip {
            opacity: 1;
            visibility: visible;
        }
        
        .risk-metric-value {
            font-size: 1.5em;
            font-weight: 700;
            color: #333;
        }
        
        .risk-metric-max {
            font-size: 0.8em;
            color: #888;
        }
        
        .risk-summary {
            background: linear-gradient(45deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        
        .risk-summary h4 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .risk-summary p {
            color: #666;
            line-height: 1.5;
            margin-bottom: 8px;
        }
        
        .methodology-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 10px;
            margin-top: 15px;
        }
        
        .methodology-section h5 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        
        .methodology-section p {
            color: #666;
            line-height: 1.5;
            font-size: 0.95em;
        }
        
        /* Advanced Risk Indicators */
        .advanced-risk-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-top: 20px;
        }
        
        .market-context-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .market-regime {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 600;
        }
        
        .regime-bull { background: #27ae60; color: white; }
        .regime-bear { background: #e74c3c; color: white; }
        .regime-sideways { background: #f39c12; color: white; }
        
        .risk-warnings {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .risk-warning {
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid;
        }
        
        .risk-warning.high { 
            background: #fff5f5; 
            border-left-color: #e53e3e; 
            color: #742a2a; 
        }
        
        .risk-warning.medium { 
            background: #fffaf0; 
            border-left-color: #dd6b20; 
            color: #744210; 
        }
        
        .risk-warning.low { 
            background: #f0fff4; 
            border-left-color: #38a169; 
            color: #22543d; 
        }
        
        .concentration-risk {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }
        
        .concentration-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .concentration-high { background: #e53e3e; }
        .concentration-medium { background: #dd6b20; }
        .concentration-low { background: #38a169; }
        
        .footer-disclaimer {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-top: 30px;
            border-left: 4px solid #667eea;
        }
        
        .footer-disclaimer h4 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.1em;
        }
        
        .footer-disclaimer p {
            color: #666;
            line-height: 1.6;
            margin-bottom: 10px;
        }
        
        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: #4CAF50;
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.error {
            background: #f44336;
        }
        
        /* Loading states */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        /* Mobile Responsive Design - FIXED LAYOUT ISSUES */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 15px;
                border-radius: 15px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .header p {
                font-size: 1em;
            }
            
            .features-section {
                padding: 15px;
            }
            
            .features-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .feature-card {
                padding: 15px;
            }
            
            .feature-icon {
                font-size: 1.5em;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .control-group {
                margin-bottom: 10px;
            }
            
            select, input, button {
                width: 100%;
                margin-bottom: 5px;
            }
            
            .dashboard {
                grid-template-columns: 1fr;
                gap: 20px;
                margin-bottom: 50px; /* Extra space to prevent layout breaks */
            }
            
            .right-panel {
                gap: 30px; /* Increased gap for better separation */
            }
            
            .pool-list {
                max-height: 500px;
                margin-bottom: 30px; /* More space after pool list */
            }
            
            .pool-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .pool-name-section {
                width: 100%;
            }
            
            .pool-actions {
                align-self: flex-end;
            }
            
            .platform-info {
                margin-left: 0;
                margin-top: 5px;
            }
            
            .pool-stats {
                grid-template-columns: 1fr;
                gap: 5px;
            }
            
            .pool-enhanced-metrics {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
            
            .chart-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .chart-controls {
                width: 100%;
                justify-content: space-between;
                flex-wrap: wrap;
            }
            
            .chart-controls button {
                margin-bottom: 5px;
            }
            
            /* FIXED: Chart container mobile layout */
            .chart-container {
                height: 550px;
                margin-bottom: 40px; /* Increased margin */
                page-break-inside: avoid;
                background: white;
                border-radius: 15px;
                padding: 20px;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            }
            
            .chart-wrapper {
                height: 400px;
                min-height: 400px;
                margin-bottom: 20px; /* Space below chart */
            }
            
            /* FIXED: Risk analysis section spacing */
            .risk-analysis-section {
                margin-top: 30px; /* More space from chart */
                page-break-before: avoid;
                background: white;
                border-radius: 15px;
                padding: 20px;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            }
            
            .advanced-risk-section {
                margin-top: 30px; /* More space between sections */
            }
            
            .risk-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .notification {
                left: 10px;
                right: 10px;
                transform: translateY(-100px);
            }
            
            .notification.show {
                transform: translateY(0);
            }
        }
        
        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.8em;
            }
            
            .features-grid {
                grid-template-columns: 1fr;
            }
            
            .platform-info {
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
            }
            
            .pool-item {
                padding: 12px;
            }
            
            .risk-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>DeFi Pool Health Analyzer</h1>
            <p>Advanced liquidity pool risk assessment with real-time insights</p>
        </header>
        
        <!-- Features Section -->
        <div class="features-section">
            <div class="features-grid">
                <div class="feature-card" onclick="toggleWatchlist()">
                    <div class="feature-icon">‚≠ê</div>
                    <h4>Watchlist</h4>
                    <p>Track your favorite pools</p>
                </div>
                <div class="feature-card" onclick="exportData()">
                    <div class="feature-icon">üìä</div>
                    <h4>Export Report</h4>
                    <p>Download HTML report</p>
                </div>
                <div class="feature-card" onclick="toggleAlerts()">
                    <div class="feature-icon">üîî</div>
                    <h4>Price Alerts</h4>
                    <p>Get notified of changes</p>
                </div>
                <div class="feature-card" onclick="showTrending()">
                    <div class="feature-icon">üìà</div>
                    <h4>Trending</h4>
                    <p>Discover hot pools</p>
                </div>
                <div class="feature-card" onclick="showRiskAnalysis()">
                    <div class="feature-icon">üéØ</div>
                    <h4>Risk Analysis</h4>
                    <p>Detailed risk breakdown</p>
                </div>
                <div class="feature-card" onclick="showPortfolioTracker()">
                    <div class="feature-icon">üíº</div>
                    <h4>Portfolio</h4>
                    <p>Track your investments</p>
                </div>
            </div>
        </div>
        
        <!-- Watchlist Section (hidden by default) -->
        <div id="watchlist-section" class="watchlist-section" style="display: none;">
            <h4>‚≠ê Your Watchlist</h4>
            <div id="watchlist-content">
                <p>Add pools to your watchlist by clicking the ‚≠ê icon</p>
            </div>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <label>Platform</label>
                <select id="platformFilter">
                    <option value="all">All Platforms</option>
                    <option value="uniswap-v3">Uniswap V3</option>
                    <option value="sushiswap">SushiSwap</option>
                    <option value="balancer-v2">Balancer V2</option>
                    <option value="curve">Curve</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>Min TVL</label>
                <input type="number" id="minTvl" placeholder="Min TVL (USD)" value="10000">
            </div>
            
            <div class="control-group">
                <label>Risk Category</label>
                <select id="riskFilter">
                    <option value="all">All Risk Levels</option>
                    <option value="conservative">Conservative (80+)</option>
                    <option value="moderate">Moderate (60-79)</option>
                    <option value="aggressive">Aggressive (40-59)</option>
                    <option value="speculative">Speculative (<40)</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>Search Pools</label>
                <input type="text" id="searchInput" placeholder="Search tokens...">
            </div>
            
            <button onclick="refreshData()">Refresh Data</button>
        </div>
        
        <div class="dashboard">
            <div class="pool-list">
                <h3 style="margin-bottom: 20px; color: #333;">Liquidity Pools</h3>
                <div id="poolsList">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading pools...</p>
                    </div>
                </div>
            </div>
            
            <div class="right-panel">
                <div class="chart-container">
                    <div class="chart-header">
                        <div class="chart-title">Pool Performance</div>
                        <div class="chart-controls">
                            <button onclick="changeChartPeriod('7')">7D</button>
                            <button onclick="changeChartPeriod('30')" class="active">30D</button>
                            <button onclick="changeChartPeriod('90')">90D</button>
                            <button onclick="changeChartPeriod('180')">6M</button>
                            <button onclick="changeChartPeriod('365')">1Y</button>
                            <button onclick="changeChartPeriod('730')">2Y</button>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="performanceChart"></canvas>
                    </div>
                </div>
                
                <!-- Risk Analysis Section -->
                <div class="risk-analysis-section" id="riskAnalysisSection">
                    <div class="risk-analysis-header">
                        <span class="risk-analysis-title">üéØ Risk Analysis</span>
                    </div>
                    <div id="riskAnalysisContent">
                        <p style="text-align: center; color: #666; padding: 20px;">Select a pool to see detailed risk analysis</p>
                    </div>
                </div>
                
                <!-- Advanced Risk Assessment Section -->
                <div class="advanced-risk-section" id="advancedRiskSection" style="display: none;">
                    <div class="risk-analysis-header">
                        <span class="risk-analysis-title">‚ö†Ô∏è Advanced Risk Assessment</span>
                    </div>
                    <div id="advancedRiskContent">
                        <!-- Advanced risk content will be populated here -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Footer Disclaimer -->
        <div class="footer-disclaimer">
            <h4>‚ö†Ô∏è Important Disclaimer</h4>
            <p><strong>This analysis is for informational purposes only and should not be considered financial advice.</strong> DeFi investments carry significant risks including impermanent loss, smart contract vulnerabilities, and market volatility.</p>
            <p>Always conduct your own research, understand the risks involved, and consider your risk tolerance before making investment decisions. Past performance does not guarantee future results.</p>
        </div>
    </div>

    <script>
        console.log('DeFi Pool Analyzer starting...');
        
        // Configuration
        const API_BASE_URL = 'https://defi-pool-health.up.railway.app/api';
        
        // Platform logos mapping
        const platformLogos = {
            'uniswap-v3': 'https://cryptologos.cc/logos/uniswap-uni-logo.png',
            'sushiswap': 'https://cryptologos.cc/logos/sushiswap-sushi-logo.png', 
            'curve': 'https://cryptologos.cc/logos/curve-dao-token-crv-logo.png',
            'balancer-v2': 'https://cryptologos.cc/logos/balancer-bal-logo.png',
            'pancakeswap': 'https://cryptologos.cc/logos/pancakeswap-cake-logo.png'
        };
        
        const platformNames = {
            'uniswap-v3': 'Uniswap',
            'sushiswap': 'SushiSwap',
            'curve': 'Curve',
            'balancer-v2': 'Balancer',
            'pancakeswap': 'PancakeSwap'
        };
        
        // State
        let pools = [];
        let selectedPool = null;
        let chart = null;
        let currentPeriod = '30';
        
        // Watchlist functionality
        let watchlist = JSON.parse(localStorage.getItem('defi-watchlist') || '[]');
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, setting up app...');
            setupEventListeners();
            loadPools();
        });
        
        function setupEventListeners() {
            document.getElementById('platformFilter').addEventListener('change', filterPools);
            document.getElementById('minTvl').addEventListener('input', debounce(filterPools, 500));
            document.getElementById('riskFilter').addEventListener('change', filterPools);
            document.getElementById('searchInput').addEventListener('input', debounce(filterPools, 300));
        }
        
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        async function loadPools() {
            console.log('Loading pools from API...');
            try {
                showLoading();
                const response = await fetch(API_BASE_URL + '/pools?limit=50');
                console.log('API Response:', response.status, response.ok);
                
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status + ': ' + response.statusText);
                }
                
                const data = await response.json();
                console.log('Pools data:', data);
                
                if (data.success && Array.isArray(data.data)) {
                    pools = data.data;
                    console.log('Successfully loaded', pools.length, 'pools');
                    renderPools();
                    if (pools.length > 0) {
                        selectPool(pools[0]);
                    }
                    showNotification(`Loaded ${pools.length} pools successfully!`);
                } else {
                    throw new Error(data.error || 'Invalid response format');
                }
            } catch (error) {
                console.error('Error loading pools:', error);
                showError(error.message);
            }
        }
        
        function showLoading() {
            document.getElementById('poolsList').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading pools...</p>
                </div>
            `;
        }
        
        function showError(message) {
            document.getElementById('poolsList').innerHTML = `
                <div class="error">
                    <h4>Error Loading Pools</h4>
                    <p><strong>Error:</strong> ${message}</p>
                    <p><strong>API URL:</strong> ${API_BASE_URL}</p>
                    <button onclick="loadPools()" style="margin-top: 10px; padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;">Try Again</button>
                </div>
            `;
        }
        
        function renderPools() {
            console.log('Rendering', pools.length, 'pools');
            const container = document.getElementById('poolsList');
            
            if (pools.length === 0) {
                container.innerHTML = '<div class="loading"><p>No pools found</p></div>';
                return;
            }
            
            container.innerHTML = pools.map(pool => {
                const healthClass = getHealthClass(pool.health_score);
                const isSelected = selectedPool && selectedPool.pool_id === pool.pool_id;
                const isWatchlisted = watchlist.includes(pool.pool_id);
                const platformLogo = platformLogos[pool.platform] || '';
                const platformName = platformNames[pool.platform] || pool.platform;
                
                // Enhanced metrics calculations
                const volumeLevel = getVolumeLevel(pool.volume_24h, pool.tvl);
                const survivability = getSurvivabilityLevel(pool.data_points || 0);
                const riskAdjustedReturn = calculateRiskAdjustedReturn(pool.avg_apr || 0, pool.apr_volatility || 0);
                const liquidityEfficiency = pool.tvl > 0 ? (pool.volume_24h / pool.tvl * 100) : 0;
                
                return `
                    <div class="pool-item ${isSelected ? 'selected' : ''}" onclick="selectPool(${JSON.stringify(pool).replace(/"/g, '&quot;')})">
                        <div class="pool-header">
                            <div class="pool-name-section">
                                <div class="pool-name">
                                    ${pool.token_pair}
                                    <span class="survivability-badge survivability-${survivability.class}" data-tooltip="${getSurvivabilityTooltip(pool.data_points || 0)}">${survivability.label}</span>
                                    ${pool.whale_risk_penalty && pool.whale_risk_penalty >= 3 ? `<span class="whale-warning-badge" data-tooltip="${getWhaleTooltip(pool.whale_risk_penalty)}">üêã</span>` : ''}
                                    ${pool.pool_type_multiplier && pool.pool_type_multiplier > 1.01 ? `<span class="bonus-badge" data-tooltip="${getBonusTooltip(pool.pool_type_multiplier, pool.token_pair, pool.platform)}">‚≠ê</span>` : ''}
                                </div>
                                <div class="platform-info">
                                    ${platformLogo ? `<img src="${platformLogo}" alt="${platformName}" class="platform-logo" onerror="this.style.display='none'">` : ''}
                                    <span class="platform-name">${platformName}</span>
                                </div>
                            </div>
                            <div class="pool-actions">
                                <button class="watchlist-star ${isWatchlisted ? 'active' : ''}" onclick="event.stopPropagation(); toggleWatchlistItem('${pool.pool_id}', '${pool.token_pair}')">
                                    ${isWatchlisted ? '‚òÖ' : '‚òÜ'}
                                </button>
                                <div class="health-score ${healthClass}">${Math.round(pool.health_score)}</div>
                            </div>
                        </div>
                        <div class="pool-stats">
                            <div class="pool-stat">
                                <span>TVL:</span>
                                <strong>${formatNumber(pool.tvl)}</strong>
                            </div>
                            <div class="pool-stat">
                                <span>24h Volume:</span>
                                <strong class="volume-indicator">
                                    <span class="volume-badge volume-${volumeLevel.class}"></span>
                                    ${formatNumber(pool.volume_24h)}
                                </strong>
                            </div>
                            <div class="pool-stat">
                                <span>APR:</span>
                                <strong>${pool.avg_apr ? pool.avg_apr.toFixed(2) : 'N/A'}%</strong>
                            </div>
                            <div class="pool-stat">
                                <span>Risk-Adj Return:</span>
                                <strong>${pool.risk_adjusted_score ? pool.risk_adjusted_score.toFixed(1) : 'N/A'}/5</strong>
                            </div>
                        </div>
                        <div class="pool-enhanced-metrics">
                            <div class="pool-enhanced-metric">
                                <div class="pool-enhanced-metric-label">Liquidity Efficiency</div>
                                <div class="pool-enhanced-metric-value">${liquidityEfficiency.toFixed(2)}%</div>
                            </div>
                            <div class="pool-enhanced-metric">
                                <div class="pool-enhanced-metric-label">Sharpe Ratio</div>
                                <div class="pool-enhanced-metric-value">${(pool.avg_apr && pool.apr_volatility ? (pool.avg_apr / (pool.apr_volatility * 100)).toFixed(2) : 'N/A')}</div>
                            </div>
                            <div class="pool-enhanced-metric">
                                <div class="pool-enhanced-metric-label">Activity Level</div>
                                <div class="pool-enhanced-metric-value">${volumeLevel.label}</div>
                            </div>
                            <div class="pool-enhanced-metric">
                                <div class="pool-enhanced-metric-label">Data Points</div>
                                <div class="pool-enhanced-metric-value">${pool.data_points || 0}d</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function selectPool(poolData) {
            console.log('Pool selected:', poolData.pool_id);
            selectedPool = poolData;
            renderPools();
            renderChart();
            renderRiskAnalysis();
        }
        
        function renderChart() {
            if (!selectedPool || !selectedPool.historical_data) return;
            
            const ctx = document.getElementById('performanceChart').getContext('2d');
            
            if (chart) {
                chart.destroy();
            }
            
            const historical = selectedPool.historical_data;
            const periodDays = parseInt(currentPeriod);
            const startIndex = Math.max(0, historical.dates.length - periodDays);
            
            const labels = historical.dates.slice(startIndex);
            const tvlData = historical.tvl.slice(startIndex);
            const aprData = historical.apr.slice(startIndex);
            
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'TVL ($M)',
                            data: tvlData.map(v => v / 1000000),
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4,
                            yAxisID: 'y'
                        },
                        {
                            label: 'APR (%)',
                            data: aprData,
                            borderColor: '#764ba2',
                            backgroundColor: 'rgba(118, 75, 162, 0.1)',
                            tension: 0.4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${selectedPool.token_pair} - ${currentPeriod}D Performance`
                        },
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'TVL (Millions $)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'APR (%)'
                            },
                            grid: {
                                drawOnChartArea: false,
                            }
                        }
                    }
                }
            });
        }
        
        function renderRiskAnalysis() {
            if (!selectedPool) {
                document.getElementById('riskAnalysisContent').innerHTML = 
                    '<p style="text-align: center; color: #666; padding: 20px;">Select a pool to see detailed risk analysis</p>';
                document.getElementById('advancedRiskSection').style.display = 'none';
                return;
            }
            
            const pool = selectedPool;
            const riskCategory = pool.risk_category || { label: 'Unknown', description: 'Risk category not available' };
            
            const riskMetrics = [
                {
                    label: 'Liquidity Score',
                    value: pool.liquidity_score || 0,
                    max: 25,
                    explanation: 'Measures TVL stability and depth, adjusted for whale concentration risk. Higher scores indicate more stable, distributed liquidity with less volatility. Large pools with very low trading activity get penalized as they may be whale-dominated.'
                },
                {
                    label: 'Yield Score', 
                    value: pool.yield_score || 0,
                    max: 20,
                    explanation: 'Evaluates APR sustainability and consistency. Rewards pools with realistic yields (5-15% optimal) while heavily penalizing very low yields (<2%) and unsustainably high yields (>40%). Stability bonuses are capped so terrible yields cannot become good scores.'
                },
                {
                    label: 'IL Risk Score',
                    value: pool.impermanent_loss_score || 0,
                    max: 20,
                    explanation: 'Assesses impermanent loss risk based on token correlation and volatility patterns. Stablecoin pairs score highest (minimal IL), correlated pairs (ETH/stETH) score well, while exotic token pairs score lower. This helps predict potential losses from price divergence.'
                },
                {
                    label: 'Protocol Score',
                    value: pool.protocol_score || 0,
                    max: 15,
                    explanation: 'Evaluates platform security, maturity, and track record. Established protocols like Uniswap (0.9/1.0) and Curve (0.85/1.0) receive higher scores due to proven security, extensive audits, and battle-tested smart contracts. Newer protocols carry higher risk.'
                },
                {
                    label: 'Activity Score',
                    value: pool.activity_score || 0,
                    max: 10,
                    explanation: 'Analyzes trading volume patterns to identify healthy activity vs manipulation. Optimal volume/TVL ratio (2-10%) indicates real usage. Too low suggests stagnation, too high may indicate wash trading or excessive volatility.'
                },
                {
                    label: 'Track Record',
                    value: pool.track_record_score || 0,
                    max: 10,
                    explanation: 'Rewards pools with longer operational history. 2+ years gets maximum points (big survivability bonus), 1-2 years gets 8 points, 6-12 months gets 5 points. Longer track records indicate protocol stability and reduced rug risk.'
                },
                {
                    label: 'Risk-Adj Return',
                    value: pool.risk_adjusted_score || 0,
                    max: 5,
                    explanation: 'Sharpe-like ratio measuring return per unit of risk. Calculated as APR divided by volatility. Rewards pools that deliver good yields without excessive volatility. This helps identify genuinely attractive risk/reward opportunities.'
                }
            ];
            
            const content = `
                <div class="risk-grid">
                    ${riskMetrics.map(metric => `
                        <div class="risk-metric">
                            <div class="risk-metric-header">
                                <div class="risk-metric-label">${metric.label}</div>
                                <div class="info-icon">
                                    i
                                    <div class="tooltip">${metric.explanation}</div>
                                </div>
                            </div>
                            <div class="risk-metric-value">${metric.value.toFixed(1)}<span class="risk-metric-max">/${metric.max}</span></div>
                        </div>
                    `).join('')}
                </div>
                <div class="risk-summary">
                    <h4>Risk Assessment: ${riskCategory.label}</h4>
                    <p><strong>Overall Health Score:</strong> ${pool.health_score.toFixed(1)}/100</p>
                    <p><strong>Data Quality:</strong> ${pool.data_quality || 'Unknown'} (${pool.data_points || 0} days of data)</p>
                    <p><strong>Analysis:</strong> ${riskCategory.description}</p>
                    <div class="methodology-section">
                        <h5>Why This Scoring System?</h5>
                        <p>Liquidity Score carries the highest weight (25 points) because stable liquidity is fundamental to a healthy pool - it affects everything from slippage to exit ability. The 6-factor system provides comprehensive risk assessment beyond simple APR metrics, helping identify sustainable investment opportunities while avoiding high-risk or manipulated pools.</p>
                    </div>
                </div>
            `;
            
            document.getElementById('riskAnalysisContent').innerHTML = content;
            renderAdvancedRiskAnalysis(pool);
        }
        
        function renderAdvancedRiskAnalysis(pool) {
            // Show advanced risk section
            document.getElementById('advancedRiskSection').style.display = 'block';
            
            // Get market context (simulated for now)
            const marketRegime = getMarketRegime();
            const advancedRisks = assessAdvancedRisks(pool);
            
            const content = `
                <div class="market-context-indicator">
                    <span>Market Context:</span>
                    <span class="market-regime regime-${marketRegime.class}">${marketRegime.label}</span>
                    <span style="font-size: 0.9em; color: #666;">${marketRegime.description}</span>
                </div>
                
                <div class="risk-warnings">
                    ${advancedRisks.map(risk => `
                        <div class="risk-warning ${risk.severity}">
                            <h5 style="margin: 0 0 8px 0;">${risk.title}</h5>
                            <p style="margin: 0; font-size: 0.9em;">${risk.description}</p>
                            ${risk.concentration ? `
                                <div class="concentration-risk" style="margin-top: 8px;">
                                    <span class="concentration-indicator concentration-${risk.concentration.level}"></span>
                                    <span>${risk.concentration.text}</span>
                                </div>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>
                
                <div class="methodology-section" style="margin-top: 20px;">
                    <h5>Advanced Risk Factors Considered:</h5>
                    <p style="font-size: 0.9em; color: #666;">
                        ‚Ä¢ <strong>Market Regime Impact:</strong> Current market conditions affect IL risk and yield sustainability<br>
                        ‚Ä¢ <strong>Concentration Risk:</strong> Large holders can cause sudden liquidity exits<br>
                        ‚Ä¢ <strong>Protocol Maturity:</strong> Newer protocols carry higher smart contract risks<br>
                        ‚Ä¢ <strong>Liquidity Fragmentation:</strong> Competition across multiple venues<br>
                        ‚Ä¢ <strong>Track Record Weighting:</strong> Exponential importance for longer operational history
                    </p>
                </div>
            `;
            
            document.getElementById('advancedRiskContent').innerHTML = content;
        }
        
        function changeChartPeriod(period) {
            document.querySelectorAll('.chart-controls button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            currentPeriod = period;
            renderChart();
        }
        
        // Feature Functions
        function toggleWatchlist() {
            const section = document.getElementById('watchlist-section');
            section.style.display = section.style.display === 'none' ? 'block' : 'none';
            updateWatchlistDisplay();
        }
        
        function toggleWatchlistItem(poolId, poolName) {
            if (watchlist.includes(poolId)) {
                watchlist = watchlist.filter(id => id !== poolId);
                showNotification(`Removed ${poolName} from watchlist`);
            } else {
                watchlist.push(poolId);
                showNotification(`Added ${poolName} to watchlist`);
            }
            localStorage.setItem('defi-watchlist', JSON.stringify(watchlist));
            renderPools();
            updateWatchlistDisplay();
        }
        
        function updateWatchlistDisplay() {
            const content = document.getElementById('watchlist-content');
            if (watchlist.length === 0) {
                content.innerHTML = '<p>Add pools to your watchlist by clicking the ‚≠ê icon</p>';
                return;
            }
            
            const watchlistPools = pools.filter(pool => watchlist.includes(pool.pool_id));
            content.innerHTML = watchlistPools.map(pool => `
                <div class="watchlist-item">
                    <div>
                        <strong>${pool.token_pair}</strong>
                        <div class="health-score ${getHealthClass(pool.health_score)}">${Math.round(pool.health_score)}</div>
                    </div>
                    <button onclick="toggleWatchlistItem('${pool.pool_id}', '${pool.token_pair}')" style="background: none; border: none; font-size: 18px; cursor: pointer;">üóëÔ∏è</button>
                </div>
            `).join('');
        }
        
        function exportData() {
            const reportDate = new Date().toLocaleDateString();
            const reportTime = new Date().toLocaleTimeString();
            
            const topPools = pools.slice(0, 10);
            const avgHealthScore = pools.reduce((sum, p) => sum + p.health_score, 0) / pools.length;
            const totalTvl = pools.reduce((sum, p) => sum + p.tvl, 0);
            const totalVolume = pools.reduce((sum, p) => sum + p.volume_24h, 0);
            
            const htmlContent = `
                <!DOCTYPE html>
                <html lang="en">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>DeFi Pool Health Analysis Report - ${reportDate}</title>
                    <style>
                        body { 
                            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
                            margin: 40px; 
                            background: #f5f7fa; 
                            line-height: 1.6;
                        }
                        .container { 
                            max-width: 900px; 
                            margin: 0 auto; 
                            background: white; 
                            padding: 40px; 
                            border-radius: 12px; 
                            box-shadow: 0 4px 20px rgba(0,0,0,0.1); 
                        }
                        .header { 
                            text-align: center; 
                            margin-bottom: 40px; 
                            border-bottom: 3px solid #667eea; 
                            padding-bottom: 20px; 
                        }
                        .header h1 { 
                            color: #667eea; 
                            margin: 0 0 10px 0; 
                            font-size: 2.5em; 
                        }
                        .header p { 
                            color: #666; 
                            margin: 0; 
                            font-size: 1.1em;
                        }
                        .summary { 
                            display: grid; 
                            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
                            gap: 20px; 
                            margin-bottom: 40px; 
                        }
                        .summary-card { 
                            background: linear-gradient(135deg, #667eea, #764ba2); 
                            color: white; 
                            padding: 25px; 
                            border-radius: 12px; 
                            text-align: center; 
                        }
                        .summary-card h3 { 
                            margin: 0 0 15px 0; 
                            font-size: 1.1em; 
                            opacity: 0.9; 
                        }
                        .summary-card .value { 
                            font-size: 2em; 
                            font-weight: bold; 
                            margin: 0; 
                        }
                        .section {
                            margin-bottom: 40px;
                        }
                        .section h2 {
                            color: #333;
                            margin-bottom: 20px;
                            font-size: 1.5em;
                            border-bottom: 2px solid #f0f0f0;
                            padding-bottom: 10px;
                        }
                        .pools-table { 
                            width: 100%; 
                            border-collapse: collapse; 
                            margin-bottom: 30px; 
                            background: white;
                        }
                        .pools-table th, .pools-table td { 
                            padding: 15px 10px; 
                            text-align: left; 
                            border-bottom: 1px solid #eee; 
                        }
                        .pools-table th { 
                            background: #667eea; 
                            color: white; 
                            font-weight: 600; 
                            font-size: 0.9em;
                        }
                        .pools-table tr:nth-child(even) { 
                            background: #f8f9fa; 
                        }
                        .pools-table tr:hover {
                            background: #e3f2fd;
                        }
                        .risk-excellent { 
                            background: #d4edda; 
                            color: #155724; 
                            padding: 4px 8px; 
                            border-radius: 12px; 
                            font-size: 0.8em; 
                            font-weight: bold; 
                        }
                        .risk-good { 
                            background: #d1ecf1; 
                            color: #0c5460; 
                            padding: 4px 8px; 
                            border-radius: 12px; 
                            font-size: 0.8em; 
                            font-weight: bold; 
                        }
                        .risk-fair { 
                            background: #fff3cd; 
                            color: #856404; 
                            padding: 4px 8px; 
                            border-radius: 12px; 
                            font-size: 0.8em; 
                            font-weight: bold; 
                        }
                        .risk-poor { 
                            background: #f8d7da; 
                            color: #721c24; 
                            padding: 4px 8px; 
                            border-radius: 12px; 
                            font-size: 0.8em; 
                            font-weight: bold; 
                        }
                        .platform { 
                            background: #e3f2fd; 
                            color: #1565c0; 
                            padding: 3px 8px; 
                            border-radius: 8px; 
                            font-size: 0.8em; 
                            text-transform: capitalize; 
                        }
                        .footer { 
                            text-align: center; 
                            color: #666; 
                            font-size: 0.9em; 
                            border-top: 1px solid #eee; 
                            padding-top: 20px; 
                            margin-top: 40px;
                        }
                        .watchlist-section {
                            background: #f8f9fa;
                            padding: 20px;
                            border-radius: 10px;
                            margin-bottom: 30px;
                        }
                        @media print { 
                            body { background: white; margin: 0; } 
                            .container { box-shadow: none; } 
                        }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <div class="header">
                            <h1>DeFi Pool Health Analysis</h1>
                            <p>Generated on ${reportDate} at ${reportTime}</p>
                        </div>
                        
                        <div class="summary">
                            <div class="summary-card">
                                <h3>Total Pools Analyzed</h3>
                                <div class="value">${pools.length}</div>
                            </div>
                            <div class="summary-card">
                                <h3>Average Health Score</h3>
                                <div class="value">${Math.round(avgHealthScore)}/100</div>
                            </div>
                            <div class="summary-card">
                                <h3>Total TVL</h3>
                                <div class="value">${formatNumber(totalTvl)}</div>
                            </div>
                            <div class="summary-card">
                                <h3>24h Volume</h3>
                                <div class="value">${formatNumber(totalVolume)}</div>
                            </div>
                        </div>
                        
                        ${watchlist.length > 0 ? `
                        <div class="section">
                            <h2>‚≠ê Your Watchlist</h2>
                            <div class="watchlist-section">
                                <p><strong>${watchlist.length} pools</strong> in your watchlist:</p>
                                <ul style="margin-top: 15px;">
                                    ${pools.filter(p => watchlist.includes(p.pool_id)).map(p => 
                                        `<li><strong>${p.token_pair}</strong> - Health: ${p.health_score.toFixed(1)}/100 (${p.risk_category?.label || 'Unknown'})</li>`
                                    ).join('')}
                                </ul>
                            </div>
                        </div>
                        ` : ''}
                        
                        <div class="section">
                            <h2>Top ${topPools.length} Pools by Health Score</h2>
                            <table class="pools-table">
                                <thead>
                                    <tr>
                                        <th>Rank</th>
                                        <th>Token Pair</th>
                                        <th>Platform</th>
                                        <th>Health Score</th>
                                        <th>Risk Level</th>
                                        <th>TVL</th>
                                        <th>APR</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${topPools.map((pool, index) => `
                                        <tr>
                                            <td><strong>#${index + 1}</strong></td>
                                            <td><strong>${pool.token_pair}</strong></td>
                                            <td><span class="platform">${platformNames[pool.platform] || pool.platform}</span></td>
                                            <td><strong>${pool.health_score.toFixed(1)}/100</strong></td>
                                            <td><span class="risk-${getHealthClass(pool.health_score).replace('health-', '')}">${pool.risk_category?.label || 'Unknown'}</span></td>
                                            <td>${formatNumber(pool.tvl)}</td>
                                            <td>${pool.avg_apr ? pool.avg_apr.toFixed(2) + '%' : 'N/A'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="section">
                            <h2>Analysis Methodology</h2>
                            <p>This report analyzes DeFi liquidity pools using a comprehensive 6-factor health scoring system:</p>
                            <ul style="margin-top: 15px; margin-left: 20px;">
                                <li><strong>Liquidity Score (25 points):</strong> TVL stability and depth</li>
                                <li><strong>Yield Score (20 points):</strong> APR sustainability and consistency</li>
                                <li><strong>Impermanent Loss Score (20 points):</strong> Token correlation and volatility risk</li>
                                <li><strong>Protocol Score (15 points):</strong> Platform security and maturity</li>
                                <li><strong>Activity Score (10 points):</strong> Trading volume patterns</li>
                                <li><strong>Track Record Score (10 points):</strong> Historical performance data</li>
                            </ul>
                        </div>
                        
                        <div class="footer">
                            <p><strong>Disclaimer:</strong> This analysis is for informational purposes only and should not be considered financial advice. 
                            DeFi investments carry significant risks including impermanent loss, smart contract risks, and market volatility. 
                            Always conduct your own research and consider your risk tolerance before making investment decisions.</p>
                            <p style="margin-top: 15px;">Report generated by DeFi Pool Health Analyzer</p>
                        </div>
                    </div>
                </body>
                </html>
            `;
            
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `defi-pool-analysis-${new Date().toISOString().split('T')[0]}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('HTML report exported successfully!');
        }
        
        function toggleAlerts() {
            showNotification('Price alerts coming soon! We will notify you when your favorite pools hit target prices.');
        }
        
        function showTrending() {
            const trendingPools = [...pools]
                .sort((a, b) => (b.volume_24h || 0) - (a.volume_24h || 0))
                .slice(0, 10);
            
            pools = trendingPools;
            renderPools();
            showNotification('Showing top 10 trending pools by volume!');
        }
        
        function showRiskAnalysis() {
            if (!selectedPool) {
                showNotification('Please select a pool first to see detailed risk analysis', 'error');
                return;
            }
            
            // Scroll to risk analysis section
            document.getElementById('riskAnalysisSection').scrollIntoView({ 
                behavior: 'smooth',
                block: 'start'
            });
            showNotification('Risk analysis is now visible below the chart!');
        }
        
        function showPortfolioTracker() {
            showNotification('Portfolio tracking feature coming soon! Track your LP positions and PnL.');
        }
        
        // Filter functions
        async function filterPools() {
            const platform = document.getElementById('platformFilter').value;
            const minTvl = document.getElementById('minTvl').value;
            const riskCategory = document.getElementById('riskFilter').value;
            const search = document.getElementById('searchInput').value;
            
            try {
                showLoading();
                const params = new URLSearchParams();
                if (platform !== 'all') params.append('platform', platform);
                if (minTvl) params.append('minTvl', minTvl);
                if (riskCategory !== 'all') params.append('riskCategory', riskCategory);
                if (search) params.append('search', search);
                params.append('limit', '50');
                
                const response = await fetch(`${API_BASE_URL}/pools?${params.toString()}`);
                const data = await response.json();
                
                if (data.success) {
                    pools = data.data;
                    renderPools();
                    if (pools.length > 0) {
                        selectPool(pools[0]);
                    } else {
                        if (chart) {
                            chart.destroy();
                            chart = null;
                        }
                        document.getElementById('riskAnalysisContent').innerHTML = 
                            '<p style="text-align: center; color: #666; padding: 20px;">No pools found matching your criteria</p>';
                    }
                } else {
                    throw new Error(data.error || 'Failed to filter pools');
                }
            } catch (error) {
                console.error('Error filtering pools:', error);
                showNotification('Failed to filter pools: ' + error.message, 'error');
            }
        }
        
        async function refreshData() {
            try {
                showNotification('Refreshing data from server...');
                const response = await fetch(`${API_BASE_URL}/refresh`, { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    showNotification(`${data.message}. Data will update in ~30 seconds.`);
                    
                    setTimeout(async () => {
                        await loadPools();
                        showNotification('Data refresh completed!');
                    }, 32000);
                } else {
                    throw new Error(data.error || 'Refresh failed');
                }
            } catch (error) {
                console.error('Error refreshing data:', error);
                showNotification('Failed to refresh data: ' + error.message, 'error');
            }
        }
        
        // Advanced risk analysis functions - FIXED LOGIC
        function getMarketRegime() {
            // Stable market assessment instead of random
            return { 
                class: 'sideways', 
                label: 'Market Neutral', 
                description: 'Current conditions favor balanced risk assessment across all pool types' 
            };
        }
        
        function assessAdvancedRisks(pool) {
            const risks = [];
            
            // 1. Track Record Assessment - UPDATED thresholds for realistic 6+ months requirement
            const dataPoints = pool.data_points || 0;
            if (dataPoints < 180) { // 6 months instead of 90 days
                risks.push({
                    title: 'Short Track Record Risk',
                    description: `Only ${dataPoints} days of data available. Pools with less than 6 months of history carry higher uncertainty and haven't been tested through different market conditions.`,
                    severity: 'high'
                });
            } else if (dataPoints < 365) {
                risks.push({
                    title: 'Moderate Track Record',
                    description: `${dataPoints} days of operational history. While established, hasn't completed a full year cycle. Pools with 12+ months show better resilience patterns.`,
                    severity: 'medium'
                });
            }
            
            // 2. ENHANCED: Whale Concentration Risk - now with more detailed analysis
            const whaleRiskPenalty = pool.whale_risk_penalty || 0;
            if (whaleRiskPenalty >= 5) {
                risks.push({
                    title: 'High Whale Concentration Risk',
                    description: `Large TVL pool with very low trading activity suggests whale-dominated liquidity. Risk: Major holders could suddenly withdraw, causing severe instability and increased slippage. Penalty applied: ${whaleRiskPenalty} points.`,
                    severity: 'high',
                    concentration: { level: 'high', text: 'Whale-dominated pool - high exit risk' }
                });
            } else if (whaleRiskPenalty >= 3) {
                risks.push({
                    title: 'Moderate Whale Concentration Risk',
                    description: `Medium-sized pool with low activity relative to TVL suggests concentrated holdings. While not extreme, large holders could impact pool stability. Penalty applied: ${whaleRiskPenalty} points.`,
                    severity: 'medium',
                    concentration: { level: 'medium', text: 'Some concentration risk detected' }
                });
            } else if (whaleRiskPenalty >= 1) {
                risks.push({
                    title: 'Minor Liquidity Concentration',
                    description: `Low trading activity suggests some concentration risk. Monitor for changes in liquidity distribution. Small penalty applied: ${whaleRiskPenalty} point.`,
                    severity: 'low',
                    concentration: { level: 'low', text: 'Minor concentration detected' }
                });
            }
            
            // 3. Protocol Security
            const protocolRisk = assessProtocolSecurityRisk(pool.platform);
            if (protocolRisk.level !== 'low') {
                risks.push({
                    title: 'Protocol Security Considerations',
                    description: protocolRisk.description,
                    severity: protocolRisk.level
                });
            }
            
            // 4. FIXED: APR Volatility Analysis - Much more selective thresholds
            const aprVolatility = pool.apr_volatility || 0;
            // Only flag genuinely concerning volatility - most pools should NOT get this warning
            if (aprVolatility > 1.2) { // Very high threshold - only for truly volatile pools
                risks.push({
                    title: 'Extreme Yield Volatility',
                    description: `APR volatility of ${(aprVolatility * 100).toFixed(1)}% indicates highly unstable returns with frequent large swings. This suggests either very unstable market conditions or potential yield farming manipulation. Consider this a high-risk investment.`,
                    severity: 'high'
                });
            } else if (aprVolatility > 0.8) { // Still quite high
                risks.push({
                    title: 'High Yield Volatility',
                    description: `APR volatility of ${(aprVolatility * 100).toFixed(1)}% indicates inconsistent returns. While not extreme, this suggests the pool may experience significant yield fluctuations. Monitor closely for stability.`,
                    severity: 'medium'
                });
            }
            // Note: No warning for volatility < 0.8 (most pools should be fine)
            
            // 5. Liquidity Fragmentation - Only show high risks
            const fragmentationRisk = assessFragmentationRisk(pool);
            if (fragmentationRisk.level === 'high') {
                risks.push({
                    title: 'Liquidity Fragmentation Risk',
                    description: fragmentationRisk.description,
                    severity: fragmentationRisk.level
                });
            }
            
            // 6. Volume/TVL Efficiency Warning
            const efficiency = pool.tvl > 0 ? (pool.volume_24h / pool.tvl) : 0;
            if (efficiency < 0.005) { // Very low activity
                risks.push({
                    title: 'Low Trading Activity',
                    description: 'Very low volume relative to TVL suggests limited market interest. This could indicate poor price discovery and higher slippage for trades.',
                    severity: 'medium'
                });
            }
            
            // If no major risks, show positive indicator
            if (risks.length === 0) {
                risks.push({
                    title: 'Strong Risk Profile',
                    description: 'This pool demonstrates solid fundamentals across all advanced risk metrics with no significant red flags identified in our analysis.',
                    severity: 'low'
                });
            }
            
            return risks;
        }
        
        function assessConcentrationRisk(pool) {
            const tvl = pool.tvl || 0;
            if (tvl < 100000) {
                return { level: 'high', text: 'Small pool - vulnerable to whale movements' };
            } else if (tvl < 1000000) {
                return { level: 'medium', text: 'Medium pool - moderate concentration risk' };
            }
            return { level: 'low', text: 'Large pool - diversified liquidity base' };
        }
        
        function assessProtocolSecurityRisk(platform) {
            const securityScores = {
                'uniswap-v3': { level: 'low', description: 'Established protocol with extensive audits and battle-tested smart contracts.' },
                'curve': { level: 'low', description: 'Highly secure protocol with strong track record and specialized in stable assets.' },
                'balancer-v2': { level: 'medium', description: 'Mature protocol but more complex architecture increases potential attack surface.' },
                'sushiswap': { level: 'medium', description: 'Established but has experienced governance and security challenges.' }
            };
            return securityScores[platform] || { level: 'high', description: 'Newer or less established protocol with higher smart contract risks.' };
        }
        
        function assessFragmentationRisk(pool) {
            const volume = pool.volume_24h || 0;
            const tvl = pool.tvl || 1;
            const efficiency = volume / tvl;
            
            if (efficiency < 0.01) {
                return { 
                    level: 'high', 
                    description: 'Low trading activity suggests liquidity may be better on other venues. Check cross-platform liquidity before large positions.' 
                };
            } else if (efficiency < 0.05) {
                return { 
                    level: 'medium', 
                    description: 'Moderate activity. Consider checking liquidity depth on competing platforms.' 
                };
            }
            return { level: 'low', description: 'Good activity levels indicate this is a primary liquidity venue.' };
        }
        
        // Utility functions
        function showNotification(message, type = 'success') {
            const existing = document.querySelectorAll('.notification');
            existing.forEach(n => n.remove());
            
            const notification = document.createElement('div');
            notification.className = `notification ${type === 'error' ? 'error' : ''}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }
        
        function formatNumber(num) {
            if (num >= 1e9) return (num / 1e9).toFixed(2) + 'B';
            if (num >= 1e6) return (num / 1e6).toFixed(2) + 'M';
            if (num >= 1e3) return (num / 1e3).toFixed(2) + 'K';
            return num ? num.toFixed(2) : '0';
        }
        
        function getHealthClass(score) {
            if (score >= 80) return 'health-excellent';
            if (score >= 60) return 'health-good';
            if (score >= 40) return 'health-fair';
            if (score >= 20) return 'health-poor';
            return 'health-critical';
        }
        
        function getVolumeLevel(volume, tvl) {
            const ratio = tvl > 0 ? volume / tvl : 0;
            if (ratio >= 0.1) return { class: 'high', label: 'High' };
            if (ratio >= 0.02) return { class: 'medium', label: 'Medium' };
            return { class: 'low', label: 'Low' };
        }
        
        // FIXED: Updated survivability levels with proper 6-month thresholds
        function getSurvivabilityLevel(dataPoints) {
            if (dataPoints >= 730) return { class: 'veteran', label: 'Veteran' };  // 2+ years - Green
            if (dataPoints >= 365) return { class: 'mature', label: 'Mature' };   // 1+ year - Orange
            if (dataPoints >= 180) return { class: 'stable', label: 'Stable' };   // 6+ months - Blue
            return { class: 'new', label: 'New' };                               // <6 months - Red
        }
        
        function calculateRiskAdjustedReturn(apr, volatility) {
            if (volatility === 0 || !volatility) return apr;
            return apr / volatility; // Simple Sharpe-like ratio
        }
        
        console.log('All functions loaded successfully');
    </script>
</body>
</html>
