.platform-badge {
            background: #3498db;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7em;
            font-weight: 600;
            text-transform: uppercase;
            margin-left: 8px;
        }
        
        .search-highlight {
            background-color: yellow;
            font-weight: bold;
        }<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced DeFi Pool Risk Analyzer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            padding: 30px;
            backdrop-filter: blur(10px);
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .header h1 {
            font-size: 3em;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.2em;
            color: #666;
        }
        
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
            align-items: end;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .control-group label {
            font-weight: 600;
            color: #333;
            font-size: 0.9em;
        }
        
        select, input, button {
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .search-container {
            position: relative;
        }
        
        .search-input {
            width: 100%;
            padding-left: 40px;
        }
        
        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .metric-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease;
            border-left: 4px solid #667eea;
        }
        
        .metric-card:hover {
            transform: translateY(-5px);
        }
        
        .metric-value {
            font-size: 2em;
            font-weight: 700;
            margin: 10px 0;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .metric-label {
            color: #666;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.9em;
            letter-spacing: 0.5px;
        }
        
        .risk-distribution {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        
        .risk-item {
            text-align: center;
            padding: 8px;
            border-radius: 8px;
            font-size: 0.8em;
            font-weight: 600;
        }
        
        .risk-conservative { background: #d4edda; color: #155724; }
        .risk-moderate { background: #fff3cd; color: #856404; }
        .risk-aggressive { background: #f8d7da; color: #721c24; }
        .risk-speculative { background: #f5c6cb; color: #721c24; }
        
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1.5fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .pool-list {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            max-height: 800px;
            overflow-y: auto;
        }
        
        .pool-header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .sort-controls {
            display: flex;
            gap: 10px;
        }
        
        .sort-button {
            padding: 8px 12px;
            background: white;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8em;
            font-weight: 600;
            transition: all 0.3s ease;
            color: #333; /* Better visibility for inactive buttons */
        }
        
        .sort-button:hover, .sort-button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .pool-item {
            background: white;
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }
        
        .pool-item:hover {
            transform: translateX(5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .pool-item.selected {
            border-left-color: #764ba2;
            background: linear-gradient(45deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
        }
        
        .pool-header-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .pool-name {
            font-weight: 700;
            font-size: 1.2em;
            color: #333;
        }
        
        .health-score {
            padding: 6px 14px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .health-excellent { background: #d4edda; color: #155724; }
        .health-good { background: #fff3cd; color: #856404; }
        .health-fair { background: #f8d7da; color: #721c24; }
        .health-poor { background: #f5c6cb; color: #721c24; }
        
        .pool-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            font-size: 0.9em;
            color: #666;
        }
        
        .pool-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .pool-stat strong {
            color: #333;
        }
        
        .risk-badge {
            position: absolute;
            top: 5px; /* Moved higher to avoid covering health scores */
            right: 5px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.65em; /* Made slightly smaller */
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .chart-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #333;
        }
        
        .chart-controls {
            display: flex;
            gap: 10px;
        }
        
        .period-button {
            padding: 8px 12px;
            background: white;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8em;
            font-weight: 600;
            transition: all 0.3s ease;
            color: #333; /* Better visibility for inactive buttons */
        }
        
        .period-button:hover, .period-button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .ai-insights {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
            border: 2px solid rgba(102, 126, 234, 0.2);
        }
        
        .ai-insights h3 {
            margin-bottom: 20px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.3em;
        }
        
        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .insight-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #667eea;
        }
        
        .insight-card.warning {
            border-left-color: #e67e22;
        }
        
        .insight-card.positive {
            border-left-color: #27ae60;
        }
        
        .insight-title {
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .insight-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 0.8em;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border: 1px solid #f5c6cb;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border: 1px solid #c3e6cb;
        }
        
        .tooltip {
            position: relative;
            cursor: help;
        }
        
        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: fixed; /* Changed from absolute to fixed */
            top: 50%; /* Center vertically on screen */
            left: 50%; /* Center horizontally on screen */
            transform: translate(-50%, -50%); /* Center the tooltip */
            background: #333;
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 0.85em;
            max-width: 300px; /* Allow wrapping for long text */
            white-space: normal; /* Allow text wrapping */
            z-index: 99999; /* Very high z-index */
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            pointer-events: none;
            text-align: center;
            line-height: 1.4;
        }
        
        @media (max-width: 1024px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .controls {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
        }
        
        @media (max-width: 768px) {
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .controls {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .insights-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Advanced DeFi Pool Risk Analyzer</h1>
            <p>Multi-protocol liquidity pool risk assessment with advanced analytics</p>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <label>Platform</label>
                <select id="platformFilter">
                    <option value="all">All Platforms</option>
                    <option value="uniswap-v3">Uniswap V3</option>
                    <option value="sushiswap">SushiSwap</option>
                    <option value="balancer-v2">Balancer V2</option>
                    <option value="curve">Curve</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>Min TVL</label>
                <input type="number" id="minTvl" placeholder="Min TVL (USD)" value="10000">
            </div>
            
            <div class="control-group">
                <label>Risk Category</label>
                <select id="riskFilter">
                    <option value="all">All Risk Levels</option>
                    <option value="conservative">Conservative (80+)</option>
                    <option value="moderate">Moderate (60-79)</option>
                    <option value="aggressive">Aggressive (40-59)</option>
                    <option value="speculative">Speculative (<40)</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>Search Pools</label>
                <div class="search-container">
                    <input type="text" id="searchInput" class="search-input" placeholder="Search tokens...">
                    <span class="search-icon">🔍</span>
                </div>
            </div>
            
            <button onclick="refreshData()">Refresh Data</button>
            <button onclick="exportData()">Export Report</button>
        </div>
        
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-label">Total Pools Analyzed</div>
                <div class="metric-value" id="totalPools">Loading...</div>
            </div>
            <div class="metric-card">
                <div class="metric-label tooltip" data-tooltip="Average health score across all pools">Average Health Score</div>
                <div class="metric-value" id="avgHealthScore">Loading...</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Total TVL</div>
                <div class="metric-value" id="totalTvl">Loading...</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">24h Volume</div>
                <div class="metric-value" id="totalVolume">Loading...</div>
            </div>
            <div class="metric-card" style="grid-column: span 2;">
                <div class="metric-label">Risk Distribution</div>
                <div class="risk-distribution" id="riskDistribution">
                    <div class="risk-item risk-conservative">Conservative<br><span id="conservativeCount">0</span></div>
                    <div class="risk-item risk-moderate">Moderate<br><span id="moderateCount">0</span></div>
                    <div class="risk-item risk-aggressive">Aggressive<br><span id="aggressiveCount">0</span></div>
                    <div class="risk-item risk-speculative">Speculative<br><span id="speculativeCount">0</span></div>
                </div>
            </div>
        </div>
        
        <div class="dashboard">
            <div class="pool-list">
                <div class="pool-header-controls">
                    <h3 style="color: #333;">Liquidity Pools</h3>
                    <div class="sort-controls">
                        <button class="sort-button active" data-sort="health_score">Health</button>
                        <button class="sort-button" data-sort="tvl">TVL</button>
                        <button class="sort-button" data-sort="volume">Volume</button>
                    </div>
                </div>
                <div id="poolsList">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Fetching pool data from blockchain...</p>
                    </div>
                </div>
            </div>
            
            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">Pool Performance Analysis</div>
                    <div class="chart-controls">
                        <button class="period-button" data-period="7">7D</button>
                        <button class="period-button active" data-period="30">30D</button>
                        <button class="period-button" data-period="90">90D</button>
                        <button class="period-button" data-period="365">1Y</button>
                    </div>
                </div>
                <canvas id="performanceChart" width="400" height="200"></canvas>
            </div>
        </div>
        
        <div class="ai-insights">
            <h3>Advanced Risk Analysis & Recommendations</h3>
            <div class="insights-grid" id="aiInsights">
                <div class="loading">Loading analysis...</div>
            </div>
        </div>
        
        <div id="statusMessage"></div>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = 'https://defi-pool-health.up.railway.app/api';
        
        // State
        let poolsData = [];
        let selectedPool = null;
        let performanceChart = null;
        let isLoading = false;
        let currentSort = 'health_score';
        let currentPeriod = 30;
        
        // Initialize application
        async function initApp() {
            setupEventListeners();
            showStatus('Initializing DeFi Pool Analyzer...', 'info');
            await fetchRealPoolData();
            await updateMetrics();
            renderPools();
            renderChart();
            generateAIInsights();
        }
        
        function setupEventListeners() {
            // Filter controls
            document.getElementById('platformFilter').addEventListener('change', handleFilterChange);
            document.getElementById('minTvl').addEventListener('input', debounce(handleFilterChange, 500));
            document.getElementById('riskFilter').addEventListener('change', handleFilterChange);
            document.getElementById('searchInput').addEventListener('input', debounce(handleFilterChange, 300));
            
            // Sort buttons
            document.querySelectorAll('.sort-button').forEach(btn => {
                btn.addEventListener('click', handleSortChange);
            });
            
            // Period buttons
            document.querySelectorAll('.period-button').forEach(btn => {
                btn.addEventListener('click', handlePeriodChange);
            });
        }
        
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        async function handleFilterChange() {
            showStatus('Filtering pools...', 'info');
            await fetchRealPoolData();
            renderPools();
        }
        
        function highlightSearchText(text, searchTerm) {
            if (!searchTerm) return text;
            const regex = new RegExp(`(${searchTerm})`, 'gi');
            return text.replace(regex, '<span class="search-highlight">$1</span>');
        }
        
        function handleSortChange(event) {
            document.querySelectorAll('.sort-button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            currentSort = event.target.getAttribute('data-sort');
            
            // Apply sorting to current pool data
            sortPoolData();
            renderPools();
        }
        
        function sortPoolData() {
            poolsData.sort((a, b) => {
                switch (currentSort) {
                    case 'tvl':
                        return b.tvl - a.tvl;
                    case 'volume':
                        return b.volume_24h - a.volume_24h;
                    case 'health_score':
                    default:
                        return b.health_score - a.health_score;
                }
            });
        }
        
        function handlePeriodChange(event) {
            document.querySelectorAll('.period-button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            currentPeriod = parseInt(event.target.getAttribute('data-period'));
            renderChart();
        }
        
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('statusMessage');
            const className = type === 'error' ? 'error-message' : 'success-message';
            statusDiv.innerHTML = `<div class="${className}">${message}</div>`;
            
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 5000);
        }
        
        // API Functions
        async function fetchRealPoolData() {
            try {
                isLoading = true;
                console.log('Fetching pool data...');
                
                const params = new URLSearchParams();
                
                const platformFilter = document.getElementById('platformFilter').value;
                if (platformFilter !== 'all') params.append('platform', platformFilter);
                
                const minTvl = document.getElementById('minTvl').value;
                if (minTvl) params.append('minTvl', minTvl);
                
                const riskFilter = document.getElementById('riskFilter').value;
                if (riskFilter !== 'all') params.append('riskCategory', riskFilter);
                
                const searchTerm = document.getElementById('searchInput').value;
                if (searchTerm) params.append('search', searchTerm);
                
                params.append('sortBy', currentSort);
                params.append('limit', '100');
                
                const url = `${API_BASE_URL}/pools?${params.toString()}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    poolsData = result.data.map(pool => ({
                        ...pool,
                        historical: parseHistoricalData(pool.historical_data)
                    }));
                    
                    showStatus(`Loaded ${poolsData.length} pools successfully!`, 'success');
                    console.log(`Loaded ${poolsData.length} pools`);
                } else {
                    throw new Error(result.error || 'Failed to fetch pool data');
                }
            } catch (error) {
                console.error('Error fetching data:', error);
                showStatus(`API Error: ${error.message}`, 'error');
            } finally {
                isLoading = false;
            }
        }
        
        async function updateMetrics() {
            try {
                const response = await fetch(`${API_BASE_URL}/metrics`);
                if (!response.ok) throw new Error('Failed to fetch metrics');
                
                const result = await response.json();
                if (result.success) {
                    const metrics = result.data;
                    
                    document.getElementById('totalPools').textContent = metrics.totalPools || 0;
                    document.getElementById('avgHealthScore').textContent = Math.round(metrics.averageHealthScore || 0);
                    document.getElementById('totalTvl').textContent = '$' + formatNumber(metrics.totalTvl || 0);
                    document.getElementById('totalVolume').textContent = '$' + formatNumber(metrics.totalVolume24h || 0);
                    
                    // Update risk distribution
                    const dist = metrics.riskDistribution || {};
                    document.getElementById('conservativeCount').textContent = dist.conservative || 0;
                    document.getElementById('moderateCount').textContent = dist.moderate || 0;
                    document.getElementById('aggressiveCount').textContent = dist.aggressive || 0;
                    document.getElementById('speculativeCount').textContent = dist.speculative || 0;
                }
            } catch (error) {
                console.error('Error updating metrics:', error);
            }
        }
        
        function parseHistoricalData(historicalData) {
            if (!historicalData || !historicalData.dates) {
                return generateMockHistoricalData();
            }
            
            const { dates, tvl, volume, fees, apr } = historicalData;
            return dates.map((date, index) => ({
                date,
                tvl: tvl[index] || 0,
                apr: apr[index] || 0,
                volume: volume[index] || 0,
                fees: fees[index] || 0,
                healthScore: 75 + (Math.random() - 0.5) * 20
            }));
        }
        
        function generateMockHistoricalData() {
            const data = [];
            const days = 365;
            let baseTvl = Math.random() * 10000000 + 1000000;
            let baseApr = Math.random() * 30 + 10;
            
            for (let d = days; d >= 0; d--) {
                const date = new Date();
                date.setDate(date.getDate() - d);
                
                baseTvl *= (1 + (Math.random() - 0.5) * 0.1);
                baseApr *= (1 + (Math.random() - 0.5) * 0.2);
                
                data.push({
                    date: date.toISOString().split('T')[0],
                    tvl: Math.max(baseTvl, 100000),
                    apr: Math.max(baseApr, 1),
                    volume: Math.random() * baseTvl * 0.3,
                    healthScore: 75 + (Math.random() - 0.5) * 30
                });
            }
            return data;
        }
        
        function renderPools() {
            const container = document.getElementById('poolsList');
            
            if (poolsData.length === 0) {
                container.innerHTML = '<div class="loading"><p>No pools match your criteria</p></div>';
                return;
            }
            
            container.innerHTML = poolsData.map(pool => {
                const healthClass = getHealthClass(pool.health_score);
                const riskCategory = pool.risk_category || { label: 'Unknown', color: '#666' };
                const isSelected = selectedPool && selectedPool.pool_id === pool.pool_id;
                
                return `
                    <div class="pool-item ${isSelected ? 'selected' : ''}" onclick="selectPool('${pool.pool_id}')">
                        <div class="risk-badge" style="background-color: ${riskCategory.color}; color: white;">
                            ${riskCategory.label}
                        </div>
                        <div class="pool-header-info">
                            <div class="pool-name">
                                ${pool.token_pair}
                                <span class="platform-badge" style="background: ${getPlatformColor(pool.platform)};">${getPlatformLabel(pool.platform)}</span>
                            </div>
                            <div class="health-score ${healthClass}">
                                ${Math.round(pool.health_score)} 
                                <span class="tooltip" data-tooltip="Health score: TVL stability, APR risk, liquidity depth, token safety, volume patterns, protocol trust">ℹ️</span>
                            </div>
                        </div>
                        <div class="pool-stats">
                            <div class="pool-stat">
                                <span>TVL:</span>
                                <strong>$${formatNumber(pool.tvl)}</strong>
                            </div>
                            <div class="pool-stat">
                                <span>24h Volume:</span>
                                <strong>$${formatNumber(pool.volume_24h)}</strong>
                            </div>
                            <div class="pool-stat">
                                <span>APR:</span>
                                <strong>${pool.avg_apr ? pool.avg_apr.toFixed(2) : 'N/A'}%</strong>
                            </div>
                            <div class="pool-stat">
                                <span>Data Points:</span>
                                <strong>${pool.data_points || 'N/A'} days</strong>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function selectPool(poolId) {
            selectedPool = poolsData.find(p => p.pool_id === poolId);
            renderPools();
            renderChart();
            generateAIInsights();
        }
        
        function renderChart() {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            
            if (performanceChart) {
                performanceChart.destroy();
            }
            
            const pool = selectedPool || poolsData[0];
            if (!pool || !pool.historical) return;
            
            // Filter data based on selected period
            const historicalData = pool.historical.slice(-currentPeriod);
            
            const labels = historicalData.map(h => h.date);
            const tvlData = historicalData.map(h => h.tvl / 1000000);
            const aprData = historicalData.map(h => h.apr);
            const healthData = historicalData.map(h => h.healthScore);
            
            performanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'TVL (Millions $)',
                            data: tvlData,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4,
                            yAxisID: 'y'
                        },
                        {
                            label: 'APR (%)',
                            data: aprData,
                            borderColor: '#764ba2',
                            backgroundColor: 'rgba(118, 75, 162, 0.1)',
                            tension: 0.4,
                            yAxisID: 'y1'
                        },
                        {
                            label: 'Health Score',
                            data: healthData,
                            borderColor: '#f093fb',
                            backgroundColor: 'rgba(240, 147, 251, 0.1)',
                            tension: 0.4,
                            yAxisID: 'y2'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: `${pool.token_pair} - ${currentPeriod}D Performance (${historicalData.length} days)`
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'TVL (Millions $)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'APR (%)'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        },
                        y2: {
                            type: 'linear',
                            display: false,
                            min: 0,
                            max: 100
                        }
                    }
                }
            });
        }
        
        function generateAIInsights() {
            const pool = selectedPool || poolsData[0];
            if (!pool) {
                document.getElementById('aiInsights').innerHTML = '<div class="loading">No pool selected for analysis</div>';
                return;
            }
            
            const insights = [];
            
            // TVL Analysis
            if (pool.tvl_stability > 20) {
                insights.push({
                    type: 'positive',
                    title: 'TVL Stability',
                    message: `Excellent TVL stability (${pool.tvl_stability.toFixed(1)}/25) indicates strong investor confidence and consistent liquidity.`
                });
            } else if (pool.tvl_stability < 10) {
                insights.push({
                    type: 'warning',
                    title: 'TVL Volatility',
                    message: `High TVL volatility (${pool.tvl_stability.toFixed(1)}/25) suggests potential liquidity risks and capital flight risk.`
                });
            }
            
            // APR Analysis
            if (pool.apr_consistency > 15) {
                insights.push({
                    type: 'positive',
                    title: 'APR Consistency',
                    message: `Strong APR consistency (${pool.apr_consistency.toFixed(1)}/25) shows reliable yield generation over time.`
                });
            } else if (pool.apr_consistency < 8) {
                insights.push({
                    type: 'warning',
                    title: 'APR Volatility',
                    message: `Inconsistent APR (${pool.apr_consistency.toFixed(1)}/25) indicates unpredictable returns and potential market instability.`
                });
            }
            
            // Volume Analysis  
            if (pool.volume_efficiency > 15) {
                insights.push({
                    type: 'positive',
                    title: 'Volume Efficiency',
                    message: `High volume efficiency (${pool.volume_efficiency.toFixed(1)}/25) shows excellent capital utilization and trading activity.`
                });
            } else if (pool.volume_efficiency < 5) {
                insights.push({
                    type: 'warning',
                    title: 'Low Volume Activity',
                    message: `Low volume efficiency (${pool.volume_efficiency.toFixed(1)}/25) may result in poor capital efficiency and higher slippage.`
                });
            }
            
            // Liquidity Analysis
            if (pool.liquidity_score > 15) {
                insights.push({
                    type: 'positive',
                    title: 'Deep Liquidity',
                    message: `Strong liquidity depth (${pool.liquidity_score.toFixed(1)}/25) provides better trade execution and lower slippage.`
                });
            } else if (pool.liquidity_score < 8) {
                insights.push({
                    type: 'warning',
                    title: 'Shallow Liquidity',
                    message: `Limited liquidity depth (${pool.liquidity_score.toFixed(1)}/25) may cause significant slippage on larger trades.`
                });
            }
            
            // Overall Assessment
            const riskCategory = pool.risk_category || { label: 'Unknown' };
            if (pool.health_score > 80) {
                insights.push({
                    type: 'positive',
                    title: 'Investment Recommendation',
                    message: `Excellent health score (${pool.health_score.toFixed(1)}/100) - ${riskCategory.label} risk profile. Suitable for conservative LP strategies.`
                });
            } else if (pool.health_score < 40) {
                insights.push({
                    type: 'warning',
                    title: 'High Risk Investment',
                    message: `Low health score (${pool.health_score.toFixed(1)}/100) - ${riskCategory.label} risk profile. Consider advanced risk management strategies.`
                });
            }
            
            const insightsHtml = insights.map(insight => {
                const iconColor = insight.type === 'positive' ? '#27ae60' : 
                                 insight.type === 'warning' ? '#e67e22' : '#3498db';
                const icon = insight.type === 'positive' ? '✓' : 
                            insight.type === 'warning' ? '⚠' : 'i';
                
                return `
                    <div class="insight-card ${insight.type}">
                        <div class="insight-title">
                            <div class="insight-icon" style="background-color: ${iconColor}">${icon}</div>
                            ${insight.title}
                        </div>
                        <div>${insight.message}</div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('aiInsights').innerHTML = insightsHtml;
        }
        
        function getPlatformColor(platform) {
            const colors = {
                'uniswap-v3': '#FF007A',
                'sushiswap': '#0E76FD', 
                'balancer-v2': '#1E1E1E',
                'curve': '#40E0D0',
                'pancakeswap': '#D1884F'
            };
            return colors[platform] || '#666';
        }
        
        function getPlatformLabel(platform) {
            const labels = {
                'uniswap-v3': 'UNI',
                'sushiswap': 'SUSHI',
                'balancer-v2': 'BAL',
                'curve': 'CURVE',
                'pancakeswap': 'CAKE'
            };
            return labels[platform] || platform.toUpperCase();
        }
        function formatNumber(num) {
            if (num >= 1e9) return (num / 1e9).toFixed(2) + 'B';
            if (num >= 1e6) return (num / 1e6).toFixed(2) + 'M';
            if (num >= 1e3) return (num / 1e3).toFixed(2) + 'K';
            return num.toFixed(2);
        }
        
        function getHealthClass(score) {
            if (score >= 80) return 'health-excellent';
            if (score >= 60) return 'health-good';
            if (score >= 40) return 'health-fair';
            return 'health-poor';
        }
        
        async function refreshData() {
            try {
                showStatus('Triggering server refresh...', 'info');
                
                const response = await fetch(`${API_BASE_URL}/refresh`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showStatus(`Server is refreshing ${result.message}. Please wait 30 seconds...`, 'success');
                    
                    // Show countdown timer
                    let countdown = 30;
                    const countdownInterval = setInterval(() => {
                        countdown--;
                        showStatus(`Refreshing data... ${countdown} seconds remaining`, 'info');
                    }, 1000);
                    
                    setTimeout(async () => {
                        clearInterval(countdownInterval);
                        showStatus('Fetching updated data...', 'info');
                        
                        await fetchRealPoolData();
                        await updateMetrics();
                        renderPools();
                        renderChart();
                        generateAIInsights();
                        
                        showStatus('Data refresh completed!', 'success');
                    }, 30000); // Wait 30 seconds for server processing
                } else {
                    throw new Error('Server refresh failed');
                }
            } catch (error) {
                console.error('Error refreshing data:', error);
                showStatus(`Refresh failed: ${error.message}`, 'error');
            }
        }
        
        function exportData() {
            try {
                const reportData = {
                    timestamp: new Date().toISOString(),
                    totalPools: poolsData.length,
                    filters: {
                        platform: document.getElementById('platformFilter').value,
                        minTvl: document.getElementById('minTvl').value,
                        riskCategory: document.getElementById('riskFilter').value,
                        search: document.getElementById('searchInput').value
                    },
                    topPools: poolsData.slice(0, 10).map(p => ({
                        pair: p.token_pair,
                        platform: p.platform,
                        healthScore: p.health_score,
                        tvl: p.tvl,
                        volume24h: p.volume_24h,
                        riskCategory: p.risk_category?.label || 'Unknown',
                        avgApr: p.avg_apr
                    })),
                    summary: {
                        avgHealthScore: poolsData.reduce((sum, p) => sum + p.health_score, 0) / poolsData.length,
                        totalTvl: poolsData.reduce((sum, p) => sum + p.tvl, 0),
                        totalVolume: poolsData.reduce((sum, p) => sum + p.volume_24h, 0)
                    }
                };
                
                generateHTMLReport(reportData);
                showStatus('User-friendly report generated!', 'success');
            } catch (error) {
                console.error('Export error:', error);
                showStatus('Export failed: ' + error.message, 'error');
            }
        }
        
        function generateHTMLReport(data) {
            const reportDate = new Date().toLocaleDateString();
            const reportTime = new Date().toLocaleTimeString();
            
            const htmlContent = `
                <!DOCTYPE html>
                <html lang="en">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>DeFi Pool Risk Analysis Report - ${reportDate}</title>
                    <style>
                        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 40px; background: #f5f7fa; }
                        .container { max-width: 800px; margin: 0 auto; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
                        .header { text-align: center; margin-bottom: 40px; border-bottom: 3px solid #667eea; padding-bottom: 20px; }
                        .header h1 { color: #667eea; margin: 0 0 10px 0; font-size: 2.2em; }
                        .header p { color: #666; margin: 0; }
                        .summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 40px; }
                        .summary-card { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 20px; border-radius: 10px; text-align: center; }
                        .summary-card h3 { margin: 0 0 10px 0; font-size: 1.1em; opacity: 0.9; }
                        .summary-card .value { font-size: 1.8em; font-weight: bold; margin: 0; }
                        .filters { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px; }
                        .filters h3 { margin: 0 0 15px 0; color: #333; }
                        .filters p { margin: 5px 0; color: #666; }
                        .pools-table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
                        .pools-table th, .pools-table td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
                        .pools-table th { background: #667eea; color: white; font-weight: 600; }
                        .pools-table tr:nth-child(even) { background: #f8f9fa; }
                        .risk-conservative { background: #d4edda; color: #155724; padding: 4px 8px; border-radius: 12px; font-size: 0.8em; font-weight: bold; }
                        .risk-moderate { background: #fff3cd; color: #856404; padding: 4px 8px; border-radius: 12px; font-size: 0.8em; font-weight: bold; }
                        .risk-aggressive { background: #f8d7da; color: #721c24; padding: 4px 8px; border-radius: 12px; font-size: 0.8em; font-weight: bold; }
                        .risk-speculative { background: #f5c6cb; color: #721c24; padding: 4px 8px; border-radius: 12px; font-size: 0.8em; font-weight: bold; }
                        .footer { text-align: center; color: #666; font-size: 0.9em; border-top: 1px solid #eee; padding-top: 20px; }
                        .platform { background: #e3f2fd; color: #1565c0; padding: 3px 8px; border-radius: 8px; font-size: 0.8em; text-transform: capitalize; }
                        @media print { body { background: white; margin: 0; } .container { box-shadow: none; } }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <div class="header">
                            <h1>Advanced DeFi Pool Risk Analysis</h1>
                            <p>Generated on ${reportDate} at ${reportTime}</p>
                        </div>
                        
                        <div class="summary">
                            <div class="summary-card">
                                <h3>Total Pools Analyzed</h3>
                                <div class="value">${data.totalPools}</div>
                            </div>
                            <div class="summary-card">
                                <h3>Average Health Score</h3>
                                <div class="value">${Math.round(data.summary.avgHealthScore)}/100</div>
                            </div>
                            <div class="summary-card">
                                <h3>Total TVL</h3>
                                <div class="value">${formatNumber(data.summary.totalTvl)}</div>
                            </div>
                            <div class="summary-card">
                                <h3>24h Volume</h3>
                                <div class="value">${formatNumber(data.summary.totalVolume)}</div>
                            </div>
                        </div>
                        
                        <div class="filters">
                            <h3>Analysis Filters Applied</h3>
                            <p><strong>Platform:</strong> ${data.filters.platform === 'all' ? 'All Platforms' : data.filters.platform}</p>
                            <p><strong>Minimum TVL:</strong> ${data.filters.minTvl ? Number(data.filters.minTvl).toLocaleString() : 'No minimum'}</p>
                            <p><strong>Risk Category:</strong> ${data.filters.riskCategory === 'all' ? 'All Risk Levels' : data.filters.riskCategory}</p>
                            <p><strong>Search:</strong> ${data.filters.search || 'No search filter'}</p>
                        </div>
                        
                        <h3 style="color: #333; margin-bottom: 20px;">Top 10 Pools by Health Score</h3>
                        <table class="pools-table">
                            <thead>
                                <tr>
                                    <th>Token Pair</th>
                                    <th>Platform</th>
                                    <th>Health Score</th>
                                    <th>Risk Level</th>
                                    <th>TVL</th>
                                    <th>APR</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.topPools.map(pool => `
                                    <tr>
                                        <td><strong>${pool.pair}</strong></td>
                                        <td><span class="platform">${pool.platform}</span></td>
                                        <td><strong>${pool.healthScore}/100</strong></td>
                                        <td><span class="risk-${pool.riskCategory.toLowerCase()}">${pool.riskCategory}</span></td>
                                        <td>${formatNumber(pool.tvl)}</td>
                                        <td>${pool.avgApr ? pool.avgApr.toFixed(2) + '%' : 'N/A'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        
                        <div class="footer">
                            <p><strong>Disclaimer:</strong> This analysis is for informational purposes only and should not be considered financial advice. 
                            DeFi investments carry significant risks including impermanent loss, smart contract risks, and market volatility. 
                            Always conduct your own research and consider your risk tolerance before making investment decisions.</p>
                            <p style="margin-top: 15px;">Report generated by Advanced DeFi Pool Risk Analyzer</p>
                        </div>
                    </div>
                </body>
                </html>
            `;
            
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `defi-pool-risk-analysis-${new Date().toISOString().split('T')[0]}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Initialize the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', initApp);
        
        // Auto-refresh every 10 minutes
        setInterval(async () => {
            console.log('Auto-refreshing metrics...');
            await updateMetrics();
        }, 600000);
    </script>
</body>
</html>
